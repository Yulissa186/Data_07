<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Archivos ARFF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Base */
    body { background-color: #3b82f6; /* azul m√°s claro que el anterior, no pastel */ padding: 20px; color: #e5e7eb; }
        h1 { font-size:24px; font-weight:500; margin-bottom:20px; color:#0f172a; }
        h6 { color:#0f172a; }
        .panda { font-size:28px; display:inline-block; margin-right:10px; vertical-align:middle; }

        /* Cards / sections */
    .table-wrapper, .plot-wrapper, .upload-form { background:#ffffff; padding:16px; border-radius:14px; border:2px solid #ffffff; box-shadow:0 6px 16px rgba(2,132,199,0.08); transition: transform .15s ease, box-shadow .15s ease; }
    .table-wrapper:hover, .plot-wrapper:hover, .upload-form:hover { transform: translateY(-2px) scale(1.01); box-shadow:0 10px 28px rgba(37,99,235,0.18); }

        /* Table card header/body */
        .data-card-header { padding:14px 20px; display:flex; align-items:center; gap:12px; background:#ffffff; border-bottom:1px solid #e5e7eb; border-top-left-radius:12px; border-top-right-radius:12px; }
        .data-card-title { color:#0f172a; font-size:16px; font-weight:600; margin:0; }
        .data-card-body { padding:16px; background:#ffffff; }

        /* Table */
        .table { margin:0; font-size:13px; border-collapse:separate; width:100%; background:#ffffff; }
        .table th { background:#f8fafc; border-bottom:1px solid #e5e7eb; font-weight:700; color:#0f172a; padding:10px 12px; text-align:left; }
        .table td { border-bottom:1px solid #e5e7eb; color:#111827; padding:10px 12px; vertical-align:middle; }
        .table tbody tr:nth-child(odd) { background: #f9fbff; }
        .table tbody tr:nth-child(even) { background: #ffffff; }
        .data-table-container { overflow-x:auto; }
        .scroll-sync { overflow-x:auto; overflow-y:hidden; height:12px; position:sticky; top:16px; z-index:999; background:transparent; }
    .scroll-sync .sync-bar { height:4px; background:#ffffff; border-radius:4px; }

        /* Form */
        .upload-form .form-label, .upload-form .form-text, .upload-form label { color: #334155; }
        .upload-form .form-control { background: #ffffff; border:1px solid #cbd5e1; color:#0f172a; box-shadow:none; }
        .upload-form .form-control::placeholder { color: #94a3b8; }
        .upload-form input[type="file"] { background: #ffffff; border:1px solid #cbd5e1; color:#0f172a; width:100%; }
        .form-check-inline { display:inline-flex; align-items:center; }
        .form-check-label { white-space:nowrap; color:#334155; }

        /* Buttons */
    .btn-primary { background-color:#2563eb; border-color:#ffffff; color:#ffffff !important; transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease; }
    .btn-primary:hover, .btn-primary:focus { background-color:#1d4ed8; border-color:#ffffff; color:#ffffff !important; transform: translateY(-1px) scale(1.02); box-shadow:0 8px 18px rgba(29,78,216,0.3); }

        /* Plots */
        .plot-wrapper h6 { font-weight:700; font-size:14px; margin-bottom:8px; color:#0f172a; }
        .plot-img { width:100%; border-radius:10px; }

    /* Lightbox */
    .lightbox-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.12); backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); display:none; align-items:center; justify-content:center; z-index:1050; opacity:0; transition: opacity .25s ease; }
    .lightbox-overlay.active { display:flex; opacity:1; }
    .lightbox-content { max-width:96vw; max-height:94vh; text-align:center; }
        .lightbox-content img { max-width:100%; max-height:88vh; border-radius:10px; box-shadow:0 14px 36px rgba(0,0,0,0.6); }
    .lightbox-caption { display:none; }
        .lightbox-close { position:absolute; top:16px; right:20px; color:#fff; font-size:28px; cursor:pointer; }
        .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); color:#fff; font-size:34px; cursor:pointer; padding:10px 16px; user-select:none; }
        .lightbox-prev { left:10px; }
        .lightbox-next { right:10px; }

        @keyframes zoomIn {
            0% { transform: scale(0.92); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
    <h1 class="text-center"><span class="panda" role="img" aria-label="panda">üêº</span>PandasArff</h1>
        
        <div class="upload-form">
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Selecciona fuente</label>
                    <div>
                        {% for radio in form.source %}
                            <div class="form-check form-check-inline">
                                {{ radio.tag }}
                                <label class="form-check-label ms-1 me-3" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="upload-block" class="mb-3 row align-items-center">
                    <div class="col-md-12">
                        <label class="form-label">Subir archivo (.arff)</label>
                        {{ form.arff_file }}
                    </div>
                </div>

                <div id="github-block" class="mb-3" style="display:none;">
                    <label class="form-label">URL del archivo en GitHub</label>
                    {{ form.github_url }}
                </div>

                <div class="d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-primary">Visualizar</button>
                </div>
            </form>
        </div>

        {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
        {% endif %}

        {% if df_html %}
            <div class="row g-3 mb-4">
                {% if protocol_col %}
                <div class="col-12">
                    <h6>Distribuci√≥n de {{ protocol_col }} (4 vistas)</h6>
                </div>
                {% if plots.prot_full %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Dataset completo</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_full }}" alt="protocol_type dataset" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_train %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Train</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_train }}" alt="protocol_type train" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_val %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Validaci√≥n</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_val }}" alt="protocol_type val" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_test %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Test</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_test }}" alt="protocol_type test" />
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <div class="table-wrapper">
                <div class="data-card-header">
                    <span class="panda" role="img" aria-label="panda" style="font-size:22px;">üêº</span>
                    <div>
                        <p class="data-card-title">Contenido: {{ file_name }}</p>
                        <small style="color:#475569;">{{ num_rows }} filas √ó {{ num_cols }} columnas</small>
                    </div>
                </div>

                <div class="data-card-body">
                    <div class="data-table-container">
                        {{ df_html|safe }}
                    </div>
                </div>
            </div>

            <div class="row mt-4 g-3">
                {% if plots.split_sizes %}
                <div class="col-md-6">
                    <div class="row mt-4 g-3"></div>
                </div>
                {% if plots.prot_full %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Dataset completo</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_full }}" alt="protocol_type dataset" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_train %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Train</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_train }}" alt="protocol_type train" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_val %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Validaci√≥n</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_val }}" alt="protocol_type val" />
                    </div>
                </div>
                {% endif %}
                {% if plots.prot_test %}
                <div class="col-md-3">
                    <div class="plot-wrapper">
                        <h6>Test</h6>
                        <img class="plot-img" src="data:image/png;base64,{{ plots.prot_test }}" alt="protocol_type test" />
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>
    <div id="lightbox" class="lightbox-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="lightbox-close" aria-label="Cerrar" title="Cerrar">√ó</div>
        <div class="lightbox-arrow lightbox-prev" aria-label="Anterior" title="Anterior">‚Äπ</div>
        <div class="lightbox-arrow lightbox-next" aria-label="Siguiente" title="Siguiente">‚Ä∫</div>
        <div class="lightbox-content">
            <img id="lightbox-img" alt="" />
            <div id="lightbox-cap" class="lightbox-caption"></div>
        </div>
    </div>

    <script>
        function toggleSource() {
            const uploadBlock = document.getElementById('upload-block');
            const githubBlock = document.getElementById('github-block');
            const radios = document.querySelectorAll('input[name="source"]');
            let val = 'upload';
            radios.forEach(r => { if (r.checked) val = r.value; });
            if (val === 'upload') {
                uploadBlock.style.display = '';
                githubBlock.style.display = 'none';
            } else {
                uploadBlock.style.display = 'none';
                githubBlock.style.display = '';
            }
        }
        document.addEventListener('DOMContentLoaded', function(){
            const radios = document.querySelectorAll('input[name="source"]')
            radios.forEach(r => r.addEventListener('change', toggleSource));
            toggleSource();

            const tableContainer = document.querySelector('.data-table-container');
            const topSync = document.createElement('div');
            topSync.className = 'scroll-sync';

            if (tableContainer) {
                const parent = tableContainer.parentNode;
                parent.insertBefore(topSync, tableContainer);

                const updateSync = () => {
                    const table = tableContainer.querySelector('table');
                    topSync.innerHTML = '';
                    if (table) {
                        const inner = document.createElement('div');
                        inner.className = 'sync-bar';
                        inner.style.width = table.scrollWidth + 'px';
                        topSync.appendChild(inner);
                    }
                };

                topSync.addEventListener('scroll', () => { tableContainer.scrollLeft = topSync.scrollLeft; });
                tableContainer.addEventListener('scroll', () => { topSync.scrollLeft = tableContainer.scrollLeft; });
                window.addEventListener('resize', updateSync);
                updateSync();
            }

            // Lightbox gallery for plots
            const imgs = Array.from(document.querySelectorAll('.plot-img'));
            const overlay = document.getElementById('lightbox');
            const imgEl = document.getElementById('lightbox-img');
            const capEl = document.getElementById('lightbox-cap');
            const btnClose = overlay.querySelector('.lightbox-close');
            const btnPrev = overlay.querySelector('.lightbox-prev');
            const btnNext = overlay.querySelector('.lightbox-next');
            let current = -1;

            function openLightbox(index){
                if(index < 0 || index >= imgs.length) return;
                current = index;
                const src = imgs[current].getAttribute('src');
                const alt = imgs[current].getAttribute('alt') || '';
                // Animaci√≥n estilo iOS ajustada: clonar desde miniatura hacia el tama√±o final real para evitar "salto" al final
                const thumb = imgs[current];
                const rect = thumb.getBoundingClientRect();
                const clone = thumb.cloneNode(true);
                clone.style.position = 'fixed';
                clone.style.left = rect.left + 'px';
                clone.style.top = rect.top + 'px';
                clone.style.width = rect.width + 'px';
                clone.style.height = rect.height + 'px';
                clone.style.margin = 0;
                clone.style.zIndex = 1100;
                clone.style.transition = 'all .35s cubic-bezier(0.16, 0.68, 0.43, 0.99)';
                clone.style.borderRadius = '10px';
                document.body.appendChild(clone);

                // Pre-cargar para conocer proporci√≥n
                const tempImg = new Image();
                tempImg.onload = () => {
                    const padding = 0.08; // 8% margen
                    const maxW = window.innerWidth * (1 - padding);
                    const maxH = window.innerHeight * (1 - padding);
                    const ratio = tempImg.naturalWidth / tempImg.naturalHeight || 1;
                    let targetW = maxW;
                    let targetH = targetW / ratio;
                    if (targetH > maxH) { targetH = maxH; targetW = targetH * ratio; }
                    const targetLeft = (window.innerWidth - targetW)/2;
                    const targetTop = (window.innerHeight - targetH)/2;

                    // Mostrar overlay; preparar imagen final con tama√±o fijo para evitar "encogimiento" al terminar
                    overlay.classList.add('active');
                    overlay.setAttribute('aria-hidden', 'false');
                    imgEl.style.opacity = '0';
                    imgEl.style.transition = 'none';
                    imgEl.style.width = targetW + 'px';
                    imgEl.style.height = targetH + 'px';
                    // Tambi√©n ajustar el contenedor para estabilizar el layout
                    const lbContent = overlay.querySelector('.lightbox-content');
                    if (lbContent) {
                        // Fijar contenedor exactamente en el destino del clon para evitar "salto"
                        lbContent.style.position = 'fixed';
                        lbContent.style.left = targetLeft + 'px';
                        lbContent.style.top = targetTop + 'px';
                        lbContent.style.width = targetW + 'px';
                        lbContent.style.height = targetH + 'px';
                    }
                    imgEl.setAttribute('src', src);
                    imgEl.setAttribute('alt', alt);
                    // No mostrar caption para evitar texto a la derecha

                    requestAnimationFrame(()=>{
                        clone.style.left = targetLeft + 'px';
                        clone.style.top = targetTop + 'px';
                        clone.style.width = targetW + 'px';
                        clone.style.height = targetH + 'px';
                        clone.style.boxShadow = '0 20px 50px rgba(0,0,0,0.55)';
                    });

                    clone.addEventListener('transitionend', ()=>{
                        clone.remove();
                        // Mostrar ya la imagen grande; evitar segundo zoom
                        requestAnimationFrame(()=>{ imgEl.style.opacity = '1'; });
                    }, { once:true });
                };
                tempImg.src = src;
            }
            function closeLightbox(){
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                // Resetear tama√±os para que el pr√≥ximo c√°lculo se aplique limpio
                imgEl.style.width = '';
                imgEl.style.height = '';
                const lbContent = overlay.querySelector('.lightbox-content');
                if (lbContent) {
                    lbContent.style.position = '';
                    lbContent.style.left = '';
                    lbContent.style.top = '';
                    lbContent.style.width = '';
                    lbContent.style.height = '';
                }
                current = -1;
            }
            function next(){ if(current !== -1) openLightbox((current + 1) % imgs.length); }
            function prev(){ if(current !== -1) openLightbox((current - 1 + imgs.length) % imgs.length); }

            imgs.forEach((img, i) => {
                img.style.cursor = 'zoom-in';
                img.addEventListener('click', () => openLightbox(i));
                img.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); openLightbox(i); }});
                img.setAttribute('tabindex', '0');
            });
            btnClose.addEventListener('click', closeLightbox);
            overlay.addEventListener('click', (e) => { if(e.target === overlay) closeLightbox(); });
            btnNext.addEventListener('click', next);
            btnPrev.addEventListener('click', prev);
            document.addEventListener('keydown', (e) => {
                if(!overlay.classList.contains('active')) return;
                if(e.key === 'Escape') closeLightbox();
                if(e.key === 'ArrowRight') next();
                if(e.key === 'ArrowLeft') prev();
            });
        });
    </script>
</body>
</html>
